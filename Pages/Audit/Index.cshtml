@page
@model buildone.Pages.Audit.IndexModel
@{
    ViewData["Title"] = "Asset Audits";
}

<div class="container-fluid mt-4">
    <div class="row mb-3">
        <div class="col">
            <h1><i class="fas fa-clipboard-check"></i> Asset Audits</h1>
            <p class="text-muted">View and manage asset audit history</p>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-info me-2" onclick="viewDeletedAudits()">
                <i class="fas fa-trash-restore"></i> View Deleted Audits
            </button>
            @* <button type="button" class="btn btn-danger me-2" onclick="confirmClearAllAudits()">
                <i class="fas fa-trash-alt"></i> Clear All History
            </button> *@
            <a asp-page="Create" class="btn btn-primary">
                <i class="fas fa-plus"></i> Start New Audit
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Audits</h5>
                    <h2>@Model.TotalAudits</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">New Assets Found</h5>
                    <h2>@Model.NewAssetsCount</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Status Changes</h5>
                    <h2>@Model.StatusChangesCount</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Location Changes</h5>
                    <h2>@Model.LocationChangesCount</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")">
                </div>
                <div class="col-md-3">
                    <label for="auditedBy" class="form-label">Audited By</label>
                    <input type="text" class="form-control" id="auditedBy" name="auditedBy" value="@Model.AuditedBy" placeholder="Enter username">
                </div>
                <div class="col-md-3">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <a asp-page="Index" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Audits Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Asset Tag</th>
                            <th>Asset Type</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Audited By</th>
                            <th>Changes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Audits.Any())
                        {
                            @foreach (var audit in Model.Audits)
                            {
                                <tr id="audit-row-@audit.Id">
                                    <td>@audit.AuditDate.ToString("MMM dd, yyyy HH:mm")</td>
                                    <td>
                                        @if (audit.IsNewAsset)
                                        {
                                            <span class="badge bg-success">NEW</span>
                                        }
                                        @audit.AssetTag
                                    </td>
                                    <td>@audit.AssetType</td>
                                    <td>
                                        @if (audit.PreviousStatus != null)
                                        {
                                            <span class="text-muted" style="text-decoration: line-through;">@audit.PreviousStatus.Value</span>
                                            <i class="fas fa-arrow-right mx-1"></i>
                                        }
                                        <span class="badge bg-info">@audit.Status</span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(audit.PreviousLocation))
                                        {
                                            <span class="text-muted" style="text-decoration: line-through;">@audit.PreviousLocation</span>
                                            <i class="fas fa-arrow-right mx-1"></i>
                                        }
                                        @(audit.Location ?? "N/A")
                                    </td>
                                    <td>@audit.AuditedBy</td>
                                    <td>
                                        @{
                                            var changes = new List<string>();
                                            if (audit.IsNewAsset) changes.Add("New Asset");
                                            if (audit.PreviousStatus != null) changes.Add("Status");
                                            if (!string.IsNullOrEmpty(audit.PreviousLocation)) changes.Add("Location");
                                        }
                                        @if (changes.Any())
                                        {
                                            @string.Join(", ", changes)
                                        }
                                        else
                                        {
                                            <span class="text-muted">No changes</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="editAudit(@audit.Id, '@audit.AssetTag', '@audit.Status', '@(audit.Location ?? "")', '@(audit.Notes?.Replace("'", "\\'").Replace("\n", " ") ?? "")')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteAudit(@audit.Id, '@audit.AssetTag')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            @if (!string.IsNullOrEmpty(audit.Notes))
                                            {
                                                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#notesModal@(audit.Id)">
                                                    <i class="fas fa-sticky-note"></i>
                                                </button>
                                            }
                                        </div>

                                        @if (!string.IsNullOrEmpty(audit.Notes))
                                        {
                                            <!-- Notes Modal -->
                                            <div class="modal fade" id="notesModal@(audit.Id)" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Audit Notes</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <p><strong>Asset:</strong> @audit.AssetTag</p>
                                                            <p><strong>Date:</strong> @audit.AuditDate.ToString("MMM dd, yyyy HH:mm")</p>
                                                            <hr>
                                                            <p>@audit.Notes</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center">
                                    <p class="mt-3">No audit records found.</p>
                                    <a asp-page="Create" class="btn btn-primary">Start Your First Audit</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Audit Modal -->
<div class="modal fade" id="editAuditModal" tabindex="-1" aria-labelledby="editAuditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editAuditModalLabel">Edit Audit Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editAuditId">
                <div class="mb-3">
                    <label for="editAssetTag" class="form-label">Asset Tag</label>
                    <input type="text" class="form-control" id="editAssetTag" readonly>
                </div>
                <div class="mb-3">
                    <label for="editStatus" class="form-label">Status</label>
                    <select class="form-select" id="editStatus">
                        <option value="Active">Active</option>
                        <option value="InStorage">In Storage</option>
                        <option value="UnderMaintenance">Under Maintenance</option>
                        <option value="Retired">Retired</option>
                        <option value="Disposed">Disposed</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editLocation" class="form-label">Location</label>
                    <input type="text" class="form-control" id="editLocation">
                </div>
                <div class="mb-3">
                    <label for="editNotes" class="form-label">Notes</label>
                    <textarea class="form-control" id="editNotes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteAuditModal" tabindex="-1" aria-labelledby="deleteAuditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAuditModalLabel">Delete Audit Record</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteAuditId">
                <p>Are you sure you want to delete this audit record?</p>
                <p><strong>Asset Tag:</strong> <span id="deleteAssetTag"></span></p>
                <div class="mb-3">
                    <label for="deletionReason" class="form-label">Reason for deletion (optional)</label>
                    <textarea class="form-control" id="deletionReason" rows="2" placeholder="Enter reason..."></textarea>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> This record will be moved to delete history for audit trail purposes.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- View Deleted Audits Modal -->
<div class="modal fade" id="deletedAuditsModal" tabindex="-1" aria-labelledby="deletedAuditsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="deletedAuditsModalLabel">
                    <i class="fas fa-trash-restore"></i> Deleted Audit History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Deleted Date</th>
                                <th>Asset Tag</th>
                                <th>Asset Type</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Audited By</th>
                                <th>Deleted By</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="deletedAuditsBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Clear All Audits Confirmation Modal -->
<div class="modal fade" id="clearAllAuditsModal" tabindex="-1" aria-labelledby="clearAllAuditsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="clearAllAuditsModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Clear All Audit History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <strong>WARNING: This action cannot be undone!</strong>
                </div>
                <p>Are you sure you want to permanently delete <strong>ALL</strong> audit records from the database?</p>
                <p>This will:</p>
                <ul>
                    <li>Delete all audit records (including deleted history)</li>
                    <li>Reset all audit statistics</li>
                    <li>Cannot be recovered</li>
                </ul>
                <div class="mb-3">
                    <label for="clearConfirmText" class="form-label">Type <strong>DELETE ALL</strong> to confirm:</label>
                    <input type="text" class="form-control" id="clearConfirmText" placeholder="DELETE ALL">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmClearAllBtn" disabled>Delete All Records</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Edit audit record
        function editAudit(auditId, assetTag, status, location, notes) {
            document.getElementById('editAuditId').value = auditId;
            document.getElementById('editAssetTag').value = assetTag;
            document.getElementById('editStatus').value = status;
            document.getElementById('editLocation').value = location;
            document.getElementById('editNotes').value = notes;

            const modal = new bootstrap.Modal(document.getElementById('editAuditModal'));
            modal.show();
        }

        // Save edited audit
        document.getElementById('saveEditBtn').addEventListener('click', function() {
            const auditId = document.getElementById('editAuditId').value;
            const data = {
                status: document.getElementById('editStatus').value,
                location: document.getElementById('editLocation').value,
                notes: document.getElementById('editNotes').value
            };

            fetch(`/api/assetaudit/update-audit/${auditId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editAuditModal')).hide();
                    location.reload(); // Reload page to show updated data
                } else {
                    alert('Error updating audit record');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating audit record');
            });
        });

        // Confirm delete audit
        function confirmDeleteAudit(auditId, assetTag) {
            document.getElementById('deleteAuditId').value = auditId;
            document.getElementById('deleteAssetTag').textContent = assetTag;
            document.getElementById('deletionReason').value = '';

            const modal = new bootstrap.Modal(document.getElementById('deleteAuditModal'));
            modal.show();
        }

        // Delete audit record
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            const auditId = document.getElementById('deleteAuditId').value;
            const reason = document.getElementById('deletionReason').value;

            fetch(`/api/assetaudit/delete-audit/${auditId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deletionReason: reason })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteAuditModal')).hide();
                    
                    // Immediately remove the row from table with fade effect
                    const row = document.getElementById(`audit-row-${auditId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => {
                            row.remove();
                            
                            // Check if table is now empty and show message
                            const tbody = row.closest('tbody');
                            if (tbody && tbody.children.length === 0) {
                                tbody.innerHTML = `
                                    <tr>
                                        <td colspan="8" class="text-center">
                                            <p class="mt-3">No audit records found.</p>
                                            <a href="/Audit/Create" class="btn btn-primary">Start Your First Audit</a>
                                        </td>
                                    </tr>
                                `;
                            }
                        }, 300);
                    }
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> Audit record deleted successfully
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    setTimeout(() => alertDiv.remove(), 3000);
                    
                    // Optionally reload after a delay to update statistics
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('Error deleting audit record');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting audit record');
            });
        });

        // View deleted audits
        function viewDeletedAudits() {
            const modal = new bootstrap.Modal(document.getElementById('deletedAuditsModal'));
            modal.show();
            
            // Load deleted audits
            const tbody = document.getElementById('deletedAuditsBody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>';
            
            fetch('/api/assetaudit/deleted-history')
                .then(response => response.json())
                .then(data => {
                    if (!data || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No deleted audit records found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = data.map(audit => `
                        <tr>
                            <td>${new Date(audit.deletedAt).toLocaleString()}</td>
                            <td><strong>${audit.assetTag}</strong></td>
                            <td>${audit.assetType || '-'}</td>
                            <td><span class="badge bg-secondary">${audit.status}</span></td>
                            <td>${audit.location || '-'}</td>
                            <td>${audit.auditedBy}</td>
                            <td>${audit.deletedBy}</td>
                            <td>${audit.deletionReason || '-'}</td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading deleted audits:', error);
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading deleted audits</td></tr>';
                });
        }

        // Confirm clear all audits
        function confirmClearAllAudits() {
            document.getElementById('clearConfirmText').value = '';
            document.getElementById('confirmClearAllBtn').disabled = true;
            
            const modal = new bootstrap.Modal(document.getElementById('clearAllAuditsModal'));
            modal.show();
        }

        // Enable delete button when correct text is entered
        document.getElementById('clearConfirmText').addEventListener('input', function() {
            const confirmBtn = document.getElementById('confirmClearAllBtn');
            confirmBtn.disabled = this.value !== 'DELETE ALL';
        });

        // Clear all audits
        document.getElementById('confirmClearAllBtn').addEventListener('click', function() {
            fetch('/api/assetaudit/clear-all', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('clearAllAuditsModal')).hide();
                    
                    // Show success message and reload
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alertDiv.style.zIndex = '9999';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle"></i> All audit records cleared successfully
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alertDiv);
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('Error clearing audit records');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing audit records');
            });
        });
    </script>
}


